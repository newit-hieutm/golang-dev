AWSTemplateFormatVersion: "2010-09-09"
Description: "Stack 2: Shared Resources (IAM Roles, S3 Buckets)"

Parameters:
  ApplicationName:
    Type: String
    Default: myapp
  Environment:
    Type: String
    Default: staging
    AllowedValues:
      - staging
      - production
  GitHubOwner:
    Type: String
    Description: "GitHub username or organization name (e.g., 'myusername' or 'myorg')"
  GitHubRepo:
    Type: String
    Description: "GitHub repository name"

Resources:
  # ==========================================
  # S3 Buckets
  # ==========================================
  ArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ApplicationName}-${Environment}-artifacts-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  PipelineBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${ApplicationName}-${Environment}-pipeline-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ==========================================
  # IAM Roles
  # ==========================================
  # 1. EC2 Instance Role
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ApplicationName}-${Environment}-ec2-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: CodeDeployAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactsBucket}/*
                  - !Sub arn:aws:s3:::${ArtifactsBucket}

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub ${ApplicationName}-${Environment}-ec2-profile
      Roles:
        - !Ref EC2InstanceRole

  # 2. CodeDeploy Service Role
  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ApplicationName}-${Environment}-codedeploy-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codedeploy.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole

  # 3. CodePipeline Service Role
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ApplicationName}-${Environment}-codepipeline-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: PipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactsBucket}/*
                  - !Sub arn:aws:s3:::${ArtifactsBucket}
                  - !Sub arn:aws:s3:::${PipelineBucket}/*
                  - !Sub arn:aws:s3:::${PipelineBucket}
                  - !Sub arn:aws:s3:::elasticbeanstalk*
              - Effect: Allow
                Action:
                  - codedeploy:CreateDeployment
                  - codedeploy:GetDeployment
                  - codedeploy:GetDeploymentConfig
                  - codedeploy:RegisterApplicationRevision
                  - codedeploy:GetApplicationRevision
                Resource: "*"

  # ==========================================
  # GitHub Actions OIDC
  # ==========================================
  # 4. GitHub OIDC Provider (one per AWS account)
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        # GitHub's OIDC thumbprint (AWS validates this automatically)
        - 6938fd4d98bab03faadb97b34396831e3780aea1
        - 1c58a3a8518e8759bf075b76b750d4f2df264fcd

  # 5. GitHub Actions Role (assumes via OIDC)
  GitHubActionsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ApplicationName}-${Environment}-github-actions-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubOIDCProvider
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                # Allow from main branch and environments
                token.actions.githubusercontent.com:sub:
                  - !Sub repo:${GitHubOwner}/${GitHubRepo}:ref:refs/heads/master
                  - !Sub repo:${GitHubOwner}/${GitHubRepo}:ref:refs/heads/main
                  - !Sub repo:${GitHubOwner}/${GitHubRepo}:ref:refs/heads/develop
                  - !Sub repo:${GitHubOwner}/${GitHubRepo}:environment:staging
                  - !Sub repo:${GitHubOwner}/${GitHubRepo}:environment:production
      Policies:
        - PolicyName: GitHubActionsS3Policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::${ArtifactsBucket}/*
                  - !Sub arn:aws:s3:::${ArtifactsBucket}
        - PolicyName: GitHubActionsPipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codepipeline:StartPipelineExecution
                  - codepipeline:GetPipelineExecution
                  - codepipeline:GetPipelineState
                Resource: !Sub arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:${ApplicationName}-${Environment}-pipeline

Outputs:
  ArtifactsBucketName:
    Value: !Ref ArtifactsBucket
    Export:
      Name: !Sub ${Environment}-ArtifactsBucketName
  PipelineBucketName:
    Value: !Ref PipelineBucket
    Export:
      Name: !Sub ${Environment}-PipelineBucketName
  EC2InstanceProfileArn:
    Value: !GetAtt EC2InstanceProfile.Arn
    Export:
      Name: !Sub ${Environment}-EC2InstanceProfileArn
  CodeDeployRoleArn:
    Value: !GetAtt CodeDeployServiceRole.Arn
    Export:
      Name: !Sub ${Environment}-CodeDeployRoleArn
  CodePipelineRoleArn:
    Value: !GetAtt CodePipelineServiceRole.Arn
    Export:
      Name: !Sub ${Environment}-CodePipelineRoleArn
  GitHubActionsRoleArn:
    Value: !GetAtt GitHubActionsRole.Arn
    Export:
      Name: !Sub ${Environment}-GitHubActionsRoleArn
    Description: "Add this ARN to GitHub secrets as AWS_ROLE_ARN"
