name: Deploy to AWS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  APP_NAME: myapp

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: "1.21"

      - name: Run tests
        run: make test

  build:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      commit: ${{ steps.version.outputs.COMMIT }}
      build_time: ${{ steps.version.outputs.TIME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0 # Required for git describe

      - name: Set up Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a # v5.2.0
        with:
          go-version: "1.21"

      - name: Get version info
        id: version
        run: |
          echo "VERSION=$(git describe --tags --always --dirty || echo 'v0.0.0')" >> $GITHUB_OUTPUT
          echo "COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Build binary
        run: make build
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          COMMIT: ${{ steps.version.outputs.COMMIT }}
          BUILD_TIME: ${{ steps.version.outputs.TIME }}

      - name: Prepare deployment package
        run: |
          mkdir -p package
          cp bin/myapp package/
          echo '{"version":"${{ steps.version.outputs.VERSION }}","commit":"${{ steps.version.outputs.COMMIT }}","buildTime":"${{ steps.version.outputs.TIME }}"}' > package/version.json
          cp -r deployments/* package/
          cd package && zip -r ../artifact.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: deployment-package
          path: artifact.zip
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment || 'staging' }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: deployment-package

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3 and trigger pipeline
        env:
          ENV_NAME: ${{ inputs.environment || 'staging' }}
          S3_BUCKET: ${{ secrets.S3_ARTIFACT_BUCKET }}
        run: |
          # Upload artifact to S3
          aws s3 cp artifact.zip "s3://${S3_BUCKET}/${ENV_NAME}/${APP_NAME}-${ENV_NAME}.zip"

          # Verify upload
          if ! aws s3 ls "s3://${S3_BUCKET}/${ENV_NAME}/${APP_NAME}-${ENV_NAME}.zip"; then
            echo "Error: Artifact not found on S3 after upload!"
            exit 1
          fi

          # Trigger CodePipeline
          PIPELINE_NAME="${APP_NAME}-${ENV_NAME}-pipeline"
          EXECUTION_ID=$(aws codepipeline start-pipeline-execution \
            --name "$PIPELINE_NAME" \
            --query 'pipelineExecutionId' \
            --output text)

          echo "Pipeline triggered successfully!"

          # Write job summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Deployment Triggered

          | Property | Value |
          |----------|-------|
          | Environment | \`${ENV_NAME}\` |
          | Version | \`${{ needs.build.outputs.version }}\` |
          | Commit | \`${{ needs.build.outputs.commit }}\` |
          | Pipeline | \`${PIPELINE_NAME}\` |
          | Execution ID | \`${EXECUTION_ID}\` |

          [View Pipeline](https://${AWS_REGION}.console.aws.amazon.com/codesuite/codepipeline/pipelines/${PIPELINE_NAME}/view)
          EOF
